package l2.gameserver.utils;

import l2.commons.util.Rnd;

public class CapchaUtil
{
	private static final String alphabet = "WJFZNYSGVRU57912";
	private static final int[] crc24tab = {0, 8388707, 8388773, 198, 8388905, 330, 396, 8389103, 8389169, 594, 660, 8389367, 792, 8389499, 8389565, 990, 8389633, 1122, 1188, 8389831, 1320, 8389963, 8390029, 1518, 1584, 8390227, 8390293, 1782, 8390425, 1914, 1980, 8390623, 8390753, 2050, 2244, 8390823, 2376, 8390955, 8391149, 2446, 2640, 8391219, 8391413, 2710, 8391545, 2842, 3036, 8391615, 3168, 8391683, 8391877, 3238, 8392009, 3370, 3564, 8392079, 8392273, 3634, 3828, 8392343, 3960, 8392475, 8392669, 4030, 8392865, 4290, 4100, 8392807, 4488, 8393195, 8393005, 4430, 4752, 8393459, 8393269, 4694, 8393657, 5082, 4892, 8393599, 5280, 8393923, 8393733, 5222, 8394121, 5610, 5420, 8394063, 8394385, 5874, 5684, 8394327, 6072, 8394715, 8394525, 6014, 6336, 8394915, 8394853, 6150, 8395241, 6538, 6476, 8395055, 8395505, 6802, 6740, 8395319, 7128, 8395707, 8395645, 6942, 8395969, 7330, 7268, 8395783, 7656, 8396171, 8396109, 7470, 7920, 8396435, 8396373, 7734, 8396761, 8122, 8060, 8396575, 8397089, 8514, 8580, 8397287, 8200, 8396907, 8396973, 8398, 8976, 8397683, 8397749, 9174, 8397369, 8794, 8860, 8397567, 9504, 8398147, 8398213, 9702, 8397833, 9322, 9388, 8398031, 8398609, 10098, 10164, 8398807, 9784, 8398427, 8398493, 9982, 10560, 8399139, 8399333, 10630, 8398953, 10250, 10444, 8399023, 8399729, 11026, 11220, 8399799, 10840, 8399419, 8399613, 10910, 8400193, 11554, 11748, 8400263, 11368, 8399883, 8400077, 11438, 12144, 8400659, 8400853, 12214, 8400473, 11834, 12028, 8400543, 12672, 8401379, 8401189, 12614, 8401065, 12490, 12300, 8401007, 8401841, 13266, 13076, 8401783, 12952, 8401659, 8401469, 12894, 8402305, 13794, 13604, 8402247, 13480, 8402123, 8401933, 13422, 14256, 8402899, 8402709, 14198, 8402585, 14074, 13884, 8402527, 8403425, 14722, 14660, 8403239, 14536, 8403115, 8403053, 14350, 15312, 8403891, 8403829, 15126, 8403705, 15002, 14940, 8403519, 15840, 8404355, 8404293, 15654, 8404169, 15530, 15468, 8403983, 8404945, 16306, 16244, 8404759, 16120, 8404635, 8404573, 15934};
	private static final long[][][] glyphs = {{{3168, 891726332900150624L, 963777742074021568L, 0}, {96, 0x60006000600060L, 27028607257805760L, 0}, {2016, 432352161397999552L, 0x600060006000600L, 0}, {2016, 27022010093666688L, 216179379284215776L, 0}, {1584, 445864265978480368L, 463877564951168560L, 0}, {1632, 459374171485373376L, 108088040349499776L, 0}, {960, 459373759111889280L, 54043607952262080L, 0}, {960, 0x660066006000600L, 495402968504337376L, 0}, {1632, 0x660066006600660L, 459374171441332608L, 0}, {1984, 459374171485374400L, 486395769249597024L, 0}, {1632, 0x660066006600660L, 459374171485373376L, 0}, {2016, 432352161397999552L, 27022010093668224L, 0}, {2016, 27022422410527104L, 108089689642107648L, 0}, {960, 0x660066006600660L, 279224001555858304L, 0}, {192, 126109310794072256L, 0xC000C000C000C0L, 0}, {960, 459374171384709312L, 108089689692440544L, 0}}, {{1636196742, 7027413971481932748L, 3921569213490666552L, 2033375231757778944L}, {66060336, 0x30003000300030L, 13511005043687520L, 558446353793941504L}, {133694976, 432352161397999608L, 0x600060006000600L, 0x600000000000000L}, {267386928, 27022422410527104L, 216176080749333504L, 0xFF0000000000000L}, {402922500, 2162879027319411140L, 1217115889971499036L, 1156299204327374848L}, {0x18181818, 878215327742165952L, 270217626934837632L, 108086391056891904L}, {66061848, 871459722295773168L, 33777100487396400L, 567453553048682496L}, {66063896, 871472916577917176L, 1736164147912511000L, 283726776524341248L}, {405805104, 1742906662456396896L, 486396181572748160L, 252201579132747776L}, {266341424, 878215327839685728L, 1134920712758234136L, 0xC0C000000000000L}, {0x18181818, 0x1818181818181818L, 1736164148113837104L, 567453553048682496L}, {133694976, 432352161429454896L, 6755502723173424L, 567453553048682496L}, {267911216, 13511211205263552L, 54044844821054208L, 0x300000000000000L}, {65013296, 871459825317840408L, 285978679420387424L, 558446353793941504L}, {25167744, 108088040349499776L, 108088040349499776L, 567453553048682496L}, {132123696, 871446630976978992L, 27023521959904768L, 1150669704793161728L}}, {{12684, 3570283082392542168L, 1898283117340265520L, 0}, {992, 0x60006000600060L, 27022010087376832L, 0}, {2016, 432352161397999552L, 0x600060006000600L, 0}, {2016, 54044020187332992L, 216176080749332448L, 0}, {3088, 1013322079691344272L, 635017237047019568L, 0}, {3120, 878208936786788736L, 108088040349499776L, 0}, {1984, 873711522084292544L, 63050807240558528L, 0}, {992, 436862358195801088L, 932258523267466224L, 0}, {3168, 891726332788999872L, 486392608105431936L, 0}, {4032, 891726332883374016L, 972791538492902448L, 0}, {3120, 878215327839685680L, 878215327839684576L, 0}, {2016, 432352161427357792L, 27022010288703424L, 0}, {2032, 13511211205263552L, 54044844821054208L, 0}, {1984, 891726332883373152L, 567453965378127744L, 0}, {384, 540433604577067392L, 108088040349501408L, 0}, {992, 445856569271255136L, 54044844846221296L, 0}}, {{2056, 578723066359581472L, 1387132050212919680L, 0x1100000000000000L}, {480, 9007336697888832L, 18014948273684736L, 2161727821137838080L}, {1020, 144117387166221312L, 567462349275924480L, 0x1000000000000000L}, {1020, 2251868535259200L, 36032095620958208L, 2296835809958952960L}, {776, 218427914907026576L, 328772256230541472L, 1170935903116328960L}, {2064, 585477022604592384L, 432349962341188608L, 0x800000000000000L}, {496, 148620986776813952L, 54043470410549312L, 1116892707587883008L}, {248, 218428980108199936L, 608003679724768288L, 558446353793941504L}, {2056, 580973216812500032L, 324265220568516096L, 0x400000000000000L}, {496, 78814127384953376L, 270220925515859040L, 585467951558164480L}, {520, 146369221340693520L, 292742909447374912L, 540431955284459520L}, {16253184, 72058693608276032L, 18014673391583360L, 0xF00000000000000L}, {66584592, 9007474141036800L, 144119586189477888L, 0x1000000000000000L}, {15728920, 150872855327802928L, 279223314340120704L, 0xF00000000000000L}, {68722622944L, 9007336697888832L, 18014948273684608L, 1143914305352105984L}, {15728904, 2251834174472224L, 18016047810479104L, 1134907106097364992L}}};
	
	public static final int buildCapcha(short text, byte font)
	{
		return (text | font << 16) & 16777215;
	}
	
	public static final short getCapchaTextPart(int capcha)
	{
		return (short) (capcha & 65535);
	}
	
	public static final byte getCapchaFontPart(int capcha)
	{
		return (byte) (capcha >> 16 & 255);
	}
	
	public static final short rgb888TOrgb565(int rgb888)
	{
		return (short) ((rgb888 >> 8 & 63496 | rgb888 >> 5 & 2016 | rgb888 >> 3 & 31) & 65535);
	}
	
	public static final String getCapchaText(int capcha)
	{
		char[] r = new char[4];
		short text = getCapchaTextPart(capcha);
		for(int i = 0;i < 4;++i)
		{
			r[i] = "WJFZNYSGVRU57912".charAt(text >> (i << 2) & 15);
		}
		return new String(r);
	}
	
	public static final byte[] getCapchaImage(int capcha, int bgcolor)
	{
		byte[] r = new byte[640];
		short text = getCapchaTextPart(capcha);
		byte font = getCapchaFontPart(capcha);
		short bgc = rgb888TOrgb565(bgcolor);
		short c = (short) ~bgc;
		r[0] = 68;
		r[1] = 68;
		r[2] = 83;
		r[3] = 32;
		r[4] = 124;
		r[8] = 7;
		r[9] = 16;
		r[10] = 8;
		r[12] = 16;
		r[16] = 64;
		r[21] = 2;
		r[76] = 32;
		r[80] = 4;
		r[84] = 68;
		r[85] = 88;
		r[86] = 84;
		r[87] = 49;
		long m = 0;
		for(int i = 0;i < 4;++i)
		{
			for(int j = 0;j < 4;++j)
			{
				m = glyphs[font >> (j << 1) & 3][text >> (j << 2) & 15][i];
				int k = 128 + (j << 5) + (i << 7);
				r[k + 0] = (byte) (bgc & 255);
				r[k + 1] = (byte) (bgc >> 8 & 255);
				r[k + 2] = (byte) (c & 255);
				r[k + 3] = (byte) (c >> 8 & 255);
				r[k + 4] = (byte) (m >> 63 & 1 | m >> 60 & 4 | m >> 57 & 16 | m >> 54 & 64);
				r[k + 5] = (byte) (m >> 47 & 1 | m >> 44 & 4 | m >> 41 & 16 | m >> 38 & 64);
				r[k + 6] = (byte) (m >> 31 & 1 | m >> 28 & 4 | m >> 25 & 16 | m >> 22 & 64);
				r[k + 7] = (byte) (m >> 15 & 1 | m >> 12 & 4 | m >> 9 & 16 | m >> 6 & 64);
				r[k + 8] = (byte) (bgc & 255);
				r[k + 9] = (byte) (bgc >> 8 & 255);
				r[k + 10] = (byte) (c & 255);
				r[k + 11] = (byte) (c >> 8 & 255);
				r[k + 12] = (byte) (m >> 59 & 1 | m >> 56 & 4 | m >> 53 & 16 | m >> 50 & 64);
				r[k + 13] = (byte) (m >> 43 & 1 | m >> 40 & 4 | m >> 37 & 16 | m >> 34 & 64);
				r[k + 14] = (byte) (m >> 27 & 1 | m >> 24 & 4 | m >> 21 & 16 | m >> 18 & 64);
				r[k + 15] = (byte) (m >> 11 & 1 | m >> 8 & 4 | m >> 5 & 16 | m >> 2 & 64);
				r[k + 16] = (byte) (bgc & 255);
				r[k + 17] = (byte) (bgc >> 8 & 255);
				r[k + 18] = (byte) (c & 255);
				r[k + 19] = (byte) (c >> 8 & 255);
				r[k + 20] = (byte) (m >> 55 & 1 | m >> 52 & 4 | m >> 49 & 16 | m >> 46 & 64);
				r[k + 21] = (byte) (m >> 39 & 1 | m >> 36 & 4 | m >> 33 & 16 | m >> 30 & 64);
				r[k + 22] = (byte) (m >> 23 & 1 | m >> 20 & 4 | m >> 17 & 16 | m >> 14 & 64);
				r[k + 23] = (byte) (m >> 7 & 1 | m >> 4 & 4 | m >> 1 & 16 | m << 2 & 64);
				r[k + 24] = (byte) (bgc & 255);
				r[k + 25] = (byte) (bgc >> 8 & 255);
				r[k + 26] = (byte) (c & 255);
				r[k + 27] = (byte) (c >> 8 & 255);
				r[k + 28] = (byte) (m >> 51 & 1 | m >> 48 & 4 | m >> 45 & 16 | m >> 42 & 64);
				r[k + 29] = (byte) (m >> 35 & 1 | m >> 32 & 4 | m >> 29 & 16 | m >> 26 & 64);
				r[k + 30] = (byte) (m >> 19 & 1 | m >> 16 & 4 | m >> 13 & 16 | m >> 10 & 64);
				r[k + 31] = (byte) (m >> 3 & 1 | m >> 0 & 4 | m << 3 & 16 | m << 6 & 64);
			}
		}
		return r;
	}
	
	public static final int getId(int capcha)
	{
		short text = getCapchaTextPart(capcha);
		byte font = getCapchaFontPart(capcha);
		int r = 11994318;
		r = r << 8 ^ crc24tab[(r >>> 16 ^ text >> 8 & 255) & 255];
		r = r << 8 ^ crc24tab[(r >>> 16 ^ text & 255) & 255];
		r = r << 8 ^ crc24tab[(r >>> 16 ^ font) & 255];
		return r & 16777215;
	}
	
	public static final int RndCapcha()
	{
		return buildCapcha((short) Rnd.get(65535), (byte) Rnd.get(255));
	}
	
	public static final int RndRGB888Color()
	{
		int r = Rnd.get(255);
		int g = Rnd.get(255);
		int b = Rnd.get(255);
		if(r >= 122 && r <= 134 && g >= 122 && g <= 134 && b >= 122 && b <= 134)
		{
			r = 0;
			g = 0;
			b = 0;
		}
		return 16777215 & r << 16 & 16711680 | g << 8 & 65280 | b & 255;
	}
	
	public static final boolean IsValidEntry(int capcha, String entry)
	{
		return entry.trim().toUpperCase().equalsIgnoreCase(getCapchaText(capcha));
	}
}